<!DOCTYPE html>
<html>
<head>
  <title>README.md</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="doc-style.css" />
  <script src="doc-filelist.js"></script>
  <script>
    var relativeDir = "", thisFile = "home/alex/github/node-dbreport/READMEmd", defaultSidebar = true;
  </script>
  <script src="doc-script.js"></script>
</head>
<body>
  <nav>
<div class="logo"><a href="http://alinex.github.io" onmouseover="lllogo.src='https://alinex.github.io/images/Alinex-200.png'" onmouseout="lllogo.src='https://alinex.github.io/images/Alinex-black-200.png'">
  <img name="lllogo" src="https://alinex.github.io/images/Alinex-black-200.png" width="150" title="Alinex Universe Homepage" />
  </a>
  <img src="http://alinex.github.io/images/Alinex-200.png" style="display:none" alt="preloading" />
</div>
<div class="links">
  <a href="http://alinex.github.io/blog" class="btn btn-primary"><span class="glyphicon-cog"></span> Blog</a>
  <a href="http://alinex.github.io/code.html" class="btn btn-warning"><span class="glyphicon-pencil"></span> Code</a>
</div>
</nav><div id="sidebar_wrapper">
    <div id="sidebar_switch">
      <span class="tree">Files</span>
      <span class="headings">Headings</span>
    </div>
    <div id="tree"></div>
    <div id="headings">
      <div class="heading h1">
        <a href="#package%3A%20alinex-dbreport">Package: alinex-dbreport</a>
      </div>
      <div class="heading h2">
        <a href="#install">Install</a>
      </div>
      <div class="heading h2">
        <a href="#usage">Usage</a>
      </div>
      <div class="heading h2">
        <a href="#configuration">Configuration</a>
      </div>
      <div class="heading h3">
        <a href="#email%20templates">Email Templates</a>
      </div>
      <div class="heading h3">
        <a href="#jobs">jobs</a>
      </div>
      <div class="heading h3">
        <a href="#database">Database</a>
      </div>
      <div class="heading h2">
        <a href="#special%20combine">Special Combine</a>
      </div>
      <div class="heading h2">
        <a href="#license">License</a>
      </div>
    </div>
  </div>
  <div id="sidebar-toggle"></div>
  <div id="container" tabindex="0"><a id="fork" href="https://github.com/alinex/node-dbreport" title="Fork me on GitHub"></a><div class="docs markdown">
<div class="pilwrap" id="package%3A%20alinex-dbreport">
  <h1>
    <a href="#package%3A%20alinex-dbreport" name="package%3A%20alinex-dbreport" class="pilcrow">&#182;</a>
    Package: alinex-dbreport
  </h1>
</div>


<p><a href="https://travis-ci.org/alinex/node-dbreport"><img src="https://travis-ci.org/alinex/node-dbreport.svg?branch=master" alt="Build Status" title="" /></a>
<a href="https://coveralls.io/r/alinex/node-dbreport?branch=master"><img src="https://coveralls.io/repos/alinex/node-dbreport/badge.png?branch=master" alt="Coverage Status" title="" /></a>
<a href="https://gemnasium.com/alinex/node-dbreport"><img src="https://gemnasium.com/alinex/node-dbreport.png" alt="Dependency Status" title="" /></a></p>

<p>Run some database queries and send their results using email. The main features are:</p>

<ul>
<li>work on any database</li>
<li>fully configurable</li>
<li>send results as csv</li>
<li>cli interface</li>
<li>pretty email format</li>
</ul>

<p>It can be started from command line or triggered using cron.</p>

<blockquote>
  <p>It is one of the modules of the <a href="http://alinex.github.io/code.html">Alinex Universe</a>
  following the code standards defined in the <a href="http://alinex.github.io/node-alinex">General Docs</a>.</p>
</blockquote>


<div class="pilwrap" id="install">
  <h2>
    <a href="#install" name="install" class="pilcrow">&#182;</a>
    Install
  </h2>
</div>


<p><a href="https://www.npmjs.com/package/alinex-dbreport"><img src="https://nodei.co/npm/alinex-dbreport.png?downloads=true&amp;downloadRank=true&amp;stars=true" alt="NPM" title="" />
 <img src="https://nodei.co/npm-dl/alinex-dbreport.png?months=9&amp;height=3" alt="Downloads" title="" />
</a></p>

<p>Install the package globally using npm on a central server. From there all your
machines may be checked:</p>


<div class="highlight"><pre><code>sudo npm install -g alinex-dbreport --production
</code></pre></div>



<p>After global installation you may directly call <code>dbreport</code> from anywhere.</p>


<div class="highlight"><pre><code>dbreport --help
</code></pre></div>



<p>Always have a look at the latest <a href="Changelog.md.html">changes</a>.</p>


<div class="pilwrap" id="usage">
  <h2>
    <a href="#usage" name="usage" class="pilcrow">&#182;</a>
    Usage
  </h2>
</div>


<p>You can simple call the <code>dbreport</code> command with at least one of the configured
reports:</p>


<div class="highlight"><pre><code><span class="o">&gt;</span> <span class="nx">dbreport</span> <span class="o">&lt;</span><span class="nx">job</span><span class="o">&gt;</span><span class="p">...</span> <span class="p">[</span><span class="o">&lt;</span><span class="nx">options</span><span class="o">&gt;</span><span class="p">]...</span>

<span class="nx">Initializing</span><span class="p">...</span>
<span class="nx">Run</span> <span class="nx">the</span> <span class="nx">jobs</span><span class="p">...</span>
<span class="o">-&gt;</span> <span class="nx">tables</span>
<span class="nx">Goodbye</span>
</code></pre></div>



<p>To get some more information call it with debugging:</p>

<pre><code>&gt; DEBUG=dbreport dbreport &lt;job&gt;... [&lt;options&gt;]...

Initializing...
Run the jobs...
-&gt; tables
  dbreport start tables job +0ms
  dbreport run query tables: SELECT table_schema, table_name FROM information_schema.tables ORDER BY table_schema, table_name +1ms
  dbreport tables: 641 rows fetched +88ms
  dbreport sending email to <a href='mailto:betriebsteam@divibib.com'>betriebsteam@divibib.com</a>... +547ms
  dbreport using SMTP +3ms
  dbreport message send {accepted: [ '<a href='mailto:betriebsteam@divibib.com'>betriebsteam@divibib.com</a>' ],
  rejected: [],
  response: '250 2.0.0 from MTA(smtp:[172.16.51.30]:10025): 250 2.0.0 Ok: queued as 7C61520AB5',
  envelope:
   { from: '<a href='mailto:alexander.schilling@divibib.com'>alexander.schilling@divibib.com</a>',
     to: [ '<a href='mailto:betriebsteam@divibib.com'>betriebsteam@divibib.com</a>' ] },
  messageId: '<a href='mailto:1454671119582-6f16f637-c8a84be8-46bf2d0c@divibib.com'>1454671119582-6f16f637-c8a84be8-46bf2d0c@divibib.com</a>' } +2ms
Goodbye
</code></pre>

<p>Global options:</p>


<div class="highlight"><pre><code><span class="o">-</span><span class="nx">C</span><span class="p">,</span> <span class="o">--</span><span class="nx">nocolors</span>  <span class="nx">turn</span> <span class="nx">of</span> <span class="nx">color</span> <span class="nx">output</span>
<span class="o">-</span><span class="nx">v</span><span class="p">,</span> <span class="o">--</span><span class="nx">verbose</span>   <span class="nx">run</span> <span class="k">in</span> <span class="nx">verbose</span> <span class="nx">mode</span>
<span class="o">-</span><span class="nx">h</span><span class="p">,</span> <span class="o">--</span><span class="nx">help</span>      <span class="nx">Show</span> <span class="nx">help</span>
</code></pre></div>



<p>Use other email address for test:</p>


<div class="highlight"><pre><code><span class="o">-</span><span class="nx">m</span><span class="p">,</span> <span class="o">--</span><span class="nx">mail</span>      <span class="nx">give</span> <span class="nx">a</span> <span class="nx">specific</span> <span class="nx">mail</span> <span class="nx">address</span>
</code></pre></div>




<div class="pilwrap" id="configuration">
  <h2>
    <a href="#configuration" name="configuration" class="pilcrow">&#182;</a>
    Configuration
  </h2>
</div>


<p>The most parts are configurable without any code change.</p>


<div class="pilwrap" id="email%20templates">
  <h3>
    <a href="#email%20templates" name="email%20templates" class="pilcrow">&#182;</a>
    Email Templates
  </h3>
</div>


<p>This templates are used for sending emails out. They will be defined under
<code>/dbreport/email</code>:</p>

<pre><code language='yaml'># Email Templates
# =================================================


# Default Email Templates
# -------------------------------------------------
This will extend/overwrite the allready existing setup within the code.
default:
  # specify how to connect to the server
  transport: smtp://alexander.schilling%40mycompany.de:&lt;PASSWORD&gt;@mail.mycompany.de
  # sender address
  from: <a href='mailto:alexander.schilling@mycompany.de'>alexander.schilling@mycompany.de</a>
  replyTo: <a href='mailto:somebody@mycompany.de'>somebody@mycompany.de</a>

  # content
  locale: en
  subject: &gt;
    Database Report: {{name}}
  body: |+
    {{conf.title}}
    ==========================================================================

    {{conf.description}}

    Started at {{dateFormat date "LLL"}}:

    | Zeilen | Datei    | Beschreibung |
    | ------:| -------- | ------------ |
    {{#each result}}
    | {{rows}} | {{file}} | {{description}} |
    {{/each}}

    Find the files attached to your mail if data available!
</code></pre>

<p>Like you see, you can use handlebar syntax to use some variables from the code.
You can also define different templates which can be referenced from within the
job.</p>

<p>The following context variables are possible:</p>

<ul>
<li>name - the alias name for this job</li>
<li>conf... - configuration of job (object)</li>
<li>date - the date then the job was done (now)</li>
<li>result
<ul><li><job> - one entry for each job</li>
<li>rows - number of rows in result</li>
<li>file - filename</li>
<li>description - description of job (from config)</li></ul></li>
</ul>


<div class="pilwrap" id="jobs">
  <h3>
    <a href="#jobs" name="jobs" class="pilcrow">&#182;</a>
    jobs
  </h3>
</div>


<p>The main part is the configuration of each single, possible job. At best this
should be done each in it's own file like <code>/dbreport/job/xxxx</code>:</p>

<pre><code language='yaml'># Test Job
# =================================================

# Job Meta
# -------------------------------------------------
title: Vorhandene Tabellen
description: |+
  Dieser Bericht zeigt alle Tabellen die zum Zeitpunkt der Ausführung in der manage
  life Datenbank existieren. Die genaue Liste liegt als tables.csv dieser Email bei.

# Queries to Run
# -------------------------------------------------
query:
  tables:
    title: List of Tables
    description: a complete list of all relations in the database
    database: dvb_manage_live
    command: "
      SELECT    table_schema, table_name
      FROM      information_schema.tables
      ORDER BY  table_schema, table_name
      "

# Where to Send them to
# -------------------------------------------------
email:
  base: default
  to: <a href='mailto:betriebsteam@divibib.com'>betriebsteam@divibib.com</a>
</code></pre>

<p>As you see above you have the three parts to fill up:
- meta data to be used in the email like: '{{conf.title}}'
- queries with a name, the db reference name and code to execute
- email sending</p>

<p>The database is defined below. While the email mostly uses a 'base' template
and only defines the parts which are changed to the base template. So a propper
use of the templates will help you minimize the configuration for the jobs.</p>


<div class="pilwrap" id="database">
  <h3>
    <a href="#database" name="database" class="pilcrow">&#182;</a>
    Database
  </h3>
</div>


<p>Also you need the setup under <code>/database</code> like described in
<a href="http://alinex.github.io/node-database">Database</a>.
This is used to make the specific database connections.</p>


<div class="pilwrap" id="special%20combine">
  <h2>
    <a href="#special%20combine" name="special%20combine" class="pilcrow">&#182;</a>
    Special Combine
  </h2>
</div>


<p>For special reports a special combine method may be coded to use.</p>


<div class="pilwrap" id="license">
  <h2>
    <a href="#license" name="license" class="pilcrow">&#182;</a>
    License
  </h2>
</div>


<p>Copyright 2016 Alexander Schilling</p>

<p>Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at</p>

<blockquote>
  <p><a href="http://www.apache.org/licenses/LICENSE-2.0">http://www.apache.org/licenses/LICENSE-2.0</a></p>
</blockquote>

<p>Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.</p></div>
  </div>
</body>
</html>
